generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  password  String
  role      String   @default("customer") // 'admin' | 'customer'
  phone     String?
  status    String   @default("active") // 'active' | 'suspended'
  isVip     Boolean  @default(false) @map("is_vip")
  googleId  String?  @unique @map("google_id")
  createdAt DateTime @default(now()) @map("created_at")

  orders        Order[]
  payments      Payment[]
  notifications Notification[]
  reviews       Review[]
  affiliate     Affiliate?

  @@map("users")
}

model Service {
  id          Int      @id @default(autoincrement())
  name        String
  nameEn      String?  @map("name_en")
  description String   @db.Text
  descriptionEn String? @map("description_en") @db.Text
  price       Int // in cents
  imagePath   String?  @map("image_path")
  category    String
  duration    String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  orders  Order[]
  reviews Review[]

  @@map("services")
}


model Affiliate {
  id             Int      @id @default(autoincrement())
  userId         Int      @unique @map("user_id")
  referralCode   String   @unique @map("referral_code")
  commissionRate Float    @default(5.0) @map("commission_rate")
  isActive       Boolean  @default(true) @map("is_active")
  payoutMethod   String?  @map("payout_method")
  payoutEmail    String?  @map("payout_email")
  createdAt      DateTime @default(now()) @map("created_at")

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders  Order[]
  payouts Payout[]

  @@map("affiliates")
}

model Payout {
  id            Int      @id @default(autoincrement())
  affiliateId   Int      @map("affiliate_id")
  amount        Int      // in cents
  currency      String   @default("USD")
  method        String   // 'payoneer', 'paypal', etc.
  status        String   @default("pending") // 'pending', 'processing', 'completed', 'failed'
  details       Json?    // Store provider specific details safely
  transactionId String?  @map("transaction_id")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at")

  affiliate Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  orders    Order[]

  @@map("payouts")
}

model Order {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  serviceId   Int      @map("service_id")
  status      String   @default("pending")
  totalAmount Int      @map("total_amount")
  details     Json?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")
  lastNotifyAt DateTime? @map("last_notify_at")
  transactionId String? @map("transaction_id")
  currency      String   @default("USD")

  // Affiliate Fields
  affiliateId      Int?    @map("affiliate_id")
  commissionAmount Int     @default(0) @map("commission_amount") // in cents
  commissionStatus String  @default("none") @map("commission_status") // none, pending, approved, paid, cancelled

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  service       Service        @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  affiliate     Affiliate?     @relation(fields: [affiliateId], references: [id])
  payoutId      Int?           @map("payout_id")
  payout        Payout?        @relation(fields: [payoutId], references: [id])
  payments      Payment[]
  notifications Notification[]

  @@map("orders")
}

model Payment {
  id            Int      @id @default(autoincrement())
  userId        Int      @map("user_id")
  orderId       Int?     @map("order_id")
  amount        Int
  method        String
  status        String   @default("pending")
  transactionId String?  @map("transaction_id")
  currency      String   @default("USD")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at")

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  order Order? @relation(fields: [orderId], references: [id])

  @@map("payments")
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  orderId   Int?     @map("order_id")
  title     String
  message   String   @db.Text
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  order Order? @relation(fields: [orderId], references: [id])

  @@map("notifications")
}

model Review {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  serviceId Int      @map("service_id")
  rating    Int
  comment   String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@map("reviews")
}

model Setting {
  key       String   @id
  value     String   @db.Text
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("settings")
}

